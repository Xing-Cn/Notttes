# Upx
*常用指令*

> 假设命令为 `upx`, Windows 下也可能是 `upx.exe`  
> 常用格式：`upx [选项] <文件...>`  
> 我电脑上得用 `./upx ... ` 运行

---

### 基本操作

| 命令 / 选项                          | 功能说明                                           |
|-------------------------------------|----------------------------------------------------|
| `upx file.exe`                      | 使用默认设置压缩可执行文件                         |
| `upx -d file.exe`                   | 解压(脱壳)已经用 UPX 压缩的文件                    |
| `upx -d file.exe -o out.exe`        | 解压到指定输出文件, 保留原文件                     |
| `upx -l file.exe`                   | 列出文件是否被 UPX 压缩, 以及压缩率等信息           |
| `upx -t file.exe`                   | 测试压缩文件能否正常解压和执行                     |

---

### 压缩级别与性能相关

| 命令 / 选项                          | 功能说明                                           |
|-------------------------------------|----------------------------------------------------|
| `upx --best file.exe`               | 使用最高压缩率(速度慢，体积更小)                      |
| `upx --brute file.exe`              | 极端暴力搜索最优压缩参数(非常慢，仅实验用)             |
| `upx --fast file.exe`               | 速度优先的压缩(压缩率较低)                           |
| `upx -1 file.exe`                   | 压缩级别 1(最快)                                    |
| `upx -9 file.exe`                   | 压缩级别 9(最慢但压缩最大)                           |

---

### 输出与覆盖控制

| 命令 / 选项                          | 功能说明                                           |
|-------------------------------------|----------------------------------------------------|
| `upx -o out.exe file.exe`           | 指定压缩后的输出文件名                             |
| `upx -k file.exe`                   | 保留备份原始文件(如 `file.exe~`)                 |
| `upx -f file.exe`                   | 强制压缩, 即使怀疑文件可能不安全/不兼容           |
| `upx -q file.exe`                   | 安静模式(减少输出信息)                           |
| `upx -v file.exe`                   | 详细模式(显示更多压缩细节)                       |

---

### 格式与平台相关
*稍作了解*

| 命令 / 选项                          | 功能说明                                           |
|-------------------------------------|----------------------------------------------------|
| `upx --force-macos`                 | 强制把目标当作 macOS 可执行(特殊场景)           |
| `upx --force-win64`                 | 强制把目标当作 Win64 可执行                       |
| `upx --force-win32`                 | 强制把目标当作 Win32 可执行                       |
| `upx --no-lzma`                     | 禁用 LZMA 压缩算法(换用其他算法)                 |

(通常 CTF/日常只用默认自动识别, 不需要手动指定)

---

### 兼容性 / 调试辅助选项

| 命令 / 选项                          | 功能说明                                           |
|-------------------------------------|----------------------------------------------------|
| `upx --ultra-brute file.exe`        | 更暴力的压缩尝试(比 `--brute` 还慢)             |
| `upx --no-relocs`                   | 不处理重定位信息(极少用)                         |
| `upx --strip-relocs=0`              | 不删除重定位(保持更多调试信息)                   |
| `upx --overlay=copy`                | 复制 PE overlay(末尾附加数据)到压缩结果         |
| `upx --overlay=skip`                | 忽略 overlay(默认行为之一)                       |

---

### 信息与帮助

| 命令 / 选项                          | 功能说明                                           |
|-------------------------------------|----------------------------------------------------|
| `upx -V` 或 `upx --version`         | 显示 UPX 版本信息                                  |
| `upx -h` 或 `upx --help`            | 显示帮助信息和全部选项                             |
| `upx --license`                     | 显示许可证信息                                     |

---

### CTF / RE 场景最常用组合

| 场景                                  | 推荐命令                                           |
|---------------------------------------|----------------------------------------------------|
| 确认是不是 UPX 壳                      | `upx -l main.exe`                                  |
| 脱壳得到可反编译的 exe                  | `upx -d main.exe -o main_unpacked.exe`            |
| 简单压缩一个自写测试程序                | `upx test.exe` 或 `upx --best test.exe`           |
| 检查压缩后程序是否完整可用              | `upx -t main.exe`                                  |

> #### 注意魔改壳:  
> *我目前只遇到过轻度魔改的(本质还是UPX, 但无法被正确识别)*
>  
> - 在文件的开头:  
>   - 把区段名改回 `UPX0`, `UPX1`, `UPX2`
>   - 以及 `UPX!` 也需要注意
> 
> 这样就能用 UPX 正常脱壳