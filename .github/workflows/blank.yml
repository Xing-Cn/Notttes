name: é¢ã®è‡ªåŠ¨åŒ–ç¨‹åºå£¹å·~æ”¹
on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  quick-update:
    runs-on: ubuntu-latest
    steps:
    - name: è·å–ä»£ç 
      uses: actions/checkout@v4
      
    - name: å¿«é€Ÿç»Ÿè®¡
      id: stats
      run: |
        echo "ğŸ”å¼€å§‹å¿«é€Ÿç»Ÿè®¡..."
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep ".md$" | wc -l || echo "0")
        TOTAL_FILES=$(find . -name "*.md" | wc -l)
        echo "changed_count=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "total_count=$TOTAL_FILES" >> $GITHUB_OUTPUT
        
    - name: æ™ºèƒ½æ›´æ–°README
      run: |
        echo "ğŸ“æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°..."
        
        # åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
        if [ "${{ steps.stats.outputs.changed_count }}" -gt 0 ] || 
           ! grep -q "ç¬”è®°æ€»æ•°: ${{ steps.stats.outputs.total_count }} ç¯‡" README.md 2>/dev/null; then
          
          echo "ğŸ”„éœ€è¦æ›´æ–°ï¼Œå‡†å¤‡æ›¿æ¢ç»Ÿè®¡ä¿¡æ¯..."
          
          # æ–¹æ³•ï¼šå…ˆåˆ é™¤æ—§ç»Ÿè®¡ï¼Œå†æ·»åŠ æ–°ç»Ÿè®¡ï¼ˆæœ€ç¨³å®šï¼‰
          # åˆ é™¤æ—§çš„ç»Ÿè®¡åŒºå—
          if grep -q "### ğŸš€å®æ—¶ç»Ÿè®¡" README.md; then
            echo "ğŸ—‘ï¸åˆ é™¤æ—§ç»Ÿè®¡åŒºå—..."
            sed -i '/### ğŸš€å®æ—¶ç»Ÿè®¡/,/*auto updata*/d' README.md
          fi
          
          # æ·»åŠ æ–°çš„ç»Ÿè®¡åŒºå—ï¼ˆé€è¡Œæ·»åŠ ï¼Œé¿å…å¤šè¡Œæ–‡æœ¬é—®é¢˜ï¼‰
          echo "" >> README.md
          echo "### ğŸš€å®æ—¶ç»Ÿè®¡" >> README.md
          echo "> æœ€ååŒæ­¥: $(date '+%Y-%m-%d %H:%M')" >> README.md
          echo "" >> README.md
          echo "- ç¬”è®°æ€»æ•°: ${{ steps.stats.outputs.total_count }} ç¯‡" >> README.md
          echo "- æœ¬æ¬¡æ›´æ–°: ${{ steps.stats.outputs.changed_count }} ç¯‡" >> README.md
          echo "- æ£€æŸ¥çŠ¶æ€: âœ…è¿è¡Œæ­£å¸¸" >> README.md
          echo "" >> README.md
          echo "*auto updata*" >> README.md
          
          echo "âœ…README æ›´æ–°å®Œæˆ"
          echo "should_commit=true" >> $GITHUB_ENV
        else
          echo "â­ï¸ç»Ÿè®¡æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_commit=false" >> $GITHUB_ENV
        fi
        
    - name: æ¡ä»¶æäº¤
      if: env.should_commit == 'true'
      run: |
        echo "ğŸš€å¼€å§‹æäº¤æ›´æ–°..."
        git config --local user.email "a138196861120@163.com"
        git config --local user.name "Xing-Cn"
        git add README.md
        git commit -m "ğŸ“Šæ›´æ–°ç»Ÿè®¡: +${{ steps.stats.outputs.changed_count }} ç¯‡æ–°ç¬”è®°"
        git push
        echo "ğŸ‰æäº¤å®Œæˆï¼"