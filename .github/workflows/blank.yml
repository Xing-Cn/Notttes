name: é¢ã®è‡ªåŠ¨åŒ–ç¨‹åºå£¹å·~æ”¹

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ctf-stats:
    runs-on: ubuntu-latest
    steps:
    - name: è·å–ä»£ç 
      uses: actions/checkout@v4
      
    - name: å¿«é€Ÿç»Ÿè®¡
      id: stats
      run: |
        echo "ğŸ”å¼€å§‹ç»Ÿè®¡ç¬”è®°..."
        
        # è·å–å½“å‰çš„æ–‡ä»¶æ•°é‡
        CURRENT_COUNT=$(find CTFFFF!!! -name "*.md" 2>/dev/null | wc -l || echo "0")
        
        # ä»READMEä¸­è¯»å–ä¸Šä¸€æ¬¡çš„ç¬”è®°æ€»æ•°
        PREVIOUS_COUNT=$CURRENT_COUNT
        if grep -q "ç¬”è®°æ€»æ•°:" README.md 2>/dev/null; then
          # æ‰¾åˆ°åŒ…å«"ç¬”è®°æ€»æ•°:"çš„è¡Œï¼Œç„¶åæå–æ•°å­—
          COUNT_LINE=$(grep "ç¬”è®°æ€»æ•°:" README.md | tail -1)
          PREVIOUS_COUNT=$(echo "$COUNT_LINE" | grep -o '[0-9]\+' | head -1)
          
          # éªŒè¯æå–çš„æ•°å­—æ˜¯å¦æœ‰æ•ˆ
          if ! echo "$PREVIOUS_COUNT" | grep -q '^[0-9]\+$' || [ -z "$PREVIOUS_COUNT" ]; then
            PREVIOUS_COUNT=$CURRENT_COUNT
          fi
        fi
        
        # è®¡ç®—å‡€å˜åŒ–
        CTF_CHANGED=$((CURRENT_COUNT - PREVIOUS_COUNT))
        
        echo "ğŸ“Šå†å²è®°å½•: $PREVIOUS_COUNT ç¯‡ â†’ å½“å‰å®é™…: $CURRENT_COUNT ç¯‡"
        echo "ğŸ“Šå˜åŒ–: $CTF_CHANGED ç¯‡"
        echo "ğŸ“Šç»Ÿè®¡å®Œæˆ: ç¬”è®°æ€»æ•° $CURRENT_COUNT ç¯‡, æœ¬æ¬¡æ›´æ–° $CTF_CHANGED ç¯‡"
        
        echo "ctf_changed=$CTF_CHANGED" >> $GITHUB_OUTPUT
        echo "ctf_total=$CURRENT_COUNT" >> $GITHUB_OUTPUT
        
    - name: æ›´æ–°READMEç»Ÿè®¡
      run: |
        echo "ğŸ“æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°README..."
        # æ˜¾ç¤ºåŒ—äº¬æ—¶é—´ (UTC+8)
        BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M')

        # åˆ¤æ–­è§¦å‘æ–¹å¼
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          TRIGGER_SOURCE="ğŸ”„æ‰‹åŠ¨è§¦å‘"
        else
          TRIGGER_SOURCE="âœ…è‡ªåŠ¨è¿è¡Œ"
        fi

        # åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°: å¦‚æœæœ‰æ–‡ä»¶å˜åŒ–, æˆ–è€…ç¬”è®°æ€»æ•°å˜äº†, æˆ–è€…æ‰‹åŠ¨è§¦å‘
        if [ "${{ steps.stats.outputs.ctf_changed }}" -ne 0 ] || 
           [ "${{ github.event_name }}" == "workflow_dispatch" ] ||
           ! grep -q "ç¬”è®°æ€»æ•°: ${{ steps.stats.outputs.ctf_total }} ç¯‡" README.md 2>/dev/null; then
      
          echo "ğŸ”„éœ€è¦æ›´æ–°, å¼€å§‹å¤„ç†README..."
          
          # åˆ é™¤æ—§çš„ç»Ÿè®¡åŒºå—(å¦‚æœå­˜åœ¨)
          if grep -q "### ğŸš€ç¬”è®°ç»Ÿè®¡" README.md; then
            echo "ğŸ—‘ï¸åˆ é™¤æ—§ç»Ÿè®¡åŒºå—..."
            sed -i '/### ğŸš€ç¬”è®°ç»Ÿè®¡/,/*auto updata*/d' README.md
          fi
          
          # æ·»åŠ æ–°çš„ç»Ÿè®¡åŒºå—
          echo "" >> README.md
          echo "### ğŸš€ç¬”è®°ç»Ÿè®¡" >> README.md
          echo "> æœ€ååŒæ­¥: $BEIJING_TIME" >> README.md
          echo "" >> README.md
          echo "- ç¬”è®°æ€»æ•°: ${{ steps.stats.outputs.ctf_total }} ç¯‡" >> README.md
          
          # æ™ºèƒ½æ˜¾ç¤ºæ›´æ–°æ•°é‡ï¼ˆå¸¦æ­£è´Ÿå·ï¼‰
          if [ "${{ steps.stats.outputs.ctf_changed }}" -gt 0 ]; then
            echo "- æœ¬æ¬¡æ›´æ–°: +${{ steps.stats.outputs.ctf_changed }} ç¯‡" >> README.md
          elif [ "${{ steps.stats.outputs.ctf_changed }}" -lt 0 ]; then
            echo "- æœ¬æ¬¡æ›´æ–°: ${{ steps.stats.outputs.ctf_changed }} ç¯‡" >> README.md
          else
            echo "- æœ¬æ¬¡æ›´æ–°: 0 ç¯‡" >> README.md
          fi
          
          echo "- è§¦å‘æ–¹å¼: $TRIGGER_SOURCE" >> README.md
          echo "" >> README.md
          echo "*auto updata*" >> README.md
          
          echo "âœ…READMEæ›´æ–°å®Œæˆ"
          echo "should_commit=true" >> $GITHUB_ENV
        else
          echo "â­ï¸ç»Ÿè®¡æ— å˜åŒ–ï¼Œè·³è¿‡æ›´æ–°"
          echo "should_commit=false" >> $GITHUB_ENV
        fi
        
    - name: æ¡ä»¶æäº¤
      if: env.should_commit == 'true'
      run: |
        echo "ğŸš€æäº¤ç»Ÿè®¡æ›´æ–°..."
        git config --local user.email "a138196861120@163.com"
        git config --local user.name "Xing-Cn"
        git add README.md
        
        # æ™ºèƒ½æäº¤ä¿¡æ¯
        if [ "${{ steps.stats.outputs.ctf_changed }}" -gt 0 ]; then
          git commit -m "ğŸ“Šæ›´æ–°ç»Ÿè®¡: +${{ steps.stats.outputs.ctf_changed }} ç¯‡"
        elif [ "${{ steps.stats.outputs.ctf_changed }}" -lt 0 ]; then
          git commit -m "ğŸ“Šæ›´æ–°ç»Ÿè®¡: ${{ steps.stats.outputs.ctf_changed }} ç¯‡"
        else
          git commit -m "ğŸ“Šæ›´æ–°ç»Ÿè®¡"
        fi
        
        git push
        echo "ğŸ‰æäº¤å®Œæˆï¼"
