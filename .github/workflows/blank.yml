name: ç¬”è®°åº“æ™ºèƒ½æ£€æŸ¥

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    
    steps:
    # ç¬¬ä¸€æ­¥ï¼šè·å–ä»£ç 
    - name: è·å–ä»“åº“ä»£ç 
      uses: actions/checkout@v4
      
    # ç¬¬äºŒæ­¥ï¼šåŸºç¡€æ£€æŸ¥
    - name: åŸºç¡€æ£€æŸ¥
      run: |
        echo "ğŸ‰ ç¬”è®°åº“æ£€æŸ¥å¼€å§‹..."
        echo "ğŸ“ æ–‡ä»¶ç»“æ„ï¼š"
        find . -maxdepth 2 -type d | grep -v ".git" | sort
        echo "ğŸ“ ç¬”è®°ç»Ÿè®¡ï¼š"
        find . -name "*.md" | wc -l | xargs echo "æ€»Markdownæ–‡ä»¶:"
        
    # ç¬¬ä¸‰æ­¥ï¼šæ›´æ–°READMEçš„ç»Ÿè®¡ä¿¡æ¯
    - name: æ›´æ–°READMEç»Ÿè®¡
      run: |
        echo "ğŸ“Š æ­£åœ¨æ›´æ–°READMEæ˜¾ç¤º..."
        
        # ç»Ÿè®¡ä¿¡æ¯
        NOTE_COUNT=$(find . -name "*.md" | wc -l)
        LAST_UPDATE=$(git log -1 --format="%Y-%m-%d %H:%M")
        LAST_COMMIT=$(git log -1 --format="%s")
        
        # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥ç”Ÿæˆç»Ÿè®¡å†…å®¹
        cat > /tmp/stats.md << 'EOF'
        
## ğŸš€ å®æ—¶ç»Ÿè®¡
> æœ€ååŒæ­¥: 
        
- ç¬”è®°æ€»æ•°:  ç¯‡
- æœ€è¿‘æ›´æ–°: 
- æ£€æŸ¥çŠ¶æ€: âœ… è¿è¡Œæ­£å¸¸
        
*æ­¤ç»Ÿè®¡ç”± GitHub Action è‡ªåŠ¨æ›´æ–°*
EOF
        
        # æ’å…¥å®é™…æ•°æ®
        sed -i "s/æœ€ååŒæ­¥: .*/æœ€ååŒæ­¥: $LAST_UPDATE/" /tmp/stats.md
        sed -i "s/ç¬”è®°æ€»æ•°: .*/ç¬”è®°æ€»æ•°: $NOTE_COUNT ç¯‡/" /tmp/stats.md
        sed -i "s/æœ€è¿‘æ›´æ–°: .*/æœ€è¿‘æ›´æ–°: $LAST_COMMIT/" /tmp/stats.md
        
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç»Ÿè®¡åŒºå—
        if grep -q "## ğŸš€ å®æ—¶ç»Ÿè®¡" README.md; then
          echo "ğŸ“ æ›´æ–°ç°æœ‰ç»Ÿè®¡åŒºå—..."
          # åˆ é™¤æ—§çš„ç»Ÿè®¡åŒºå—ï¼ˆä» ## ğŸš€ å®æ—¶ç»Ÿè®¡ åˆ°ä¸‹ä¸€ä¸ª ## å¼€å¤´æˆ–æ–‡ä»¶ç»“å°¾ï¼‰
          sed -i '/## ğŸš€ å®æ—¶ç»Ÿè®¡/,/^## [^#]/{//!d}; /## ğŸš€ å®æ—¶ç»Ÿè®¡/d' README.md
        fi
        
        # æ·»åŠ ç»Ÿè®¡åŒºå—åˆ°README
        cat /tmp/stats.md >> README.md
        echo "âœ… README æ›´æ–°å®Œæˆï¼"
        
    # ç¬¬å››æ­¥ï¼šæäº¤æ›´æ–°
    - name: æäº¤æ›´æ”¹
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git diff --staged --quiet || git commit -m "ğŸ“Š æ›´æ–°å®æ—¶ç»Ÿè®¡ä¿¡æ¯"
        git push
